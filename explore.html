<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Systems - What's Your Metaphysics?</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- App Stats Logic -->
    <script src="js/firebase-config.js"></script>
    <script src="js/stats.js"></script>

<body>
    <div class="app-container">
        <header>
            <div class="header-content">
                <a href="index.html" class="back-home-btn" aria-label="Back to Home">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </a>
                <h1>Metaphysical Systems</h1>
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle Dark Mode">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
            <p class="subtitle">A catalog of philosophical worldviews.</p>
        </header>

        <main id="explore-content">
            <div class="navigation-top"
                style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 2rem;">
                <div class="sort-toggle">
                    <button id="sort-alpha" class="sort-btn active" title="Sort alphabetically">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h7"></path>
                            <path d="M3 12h10"></path>
                            <path d="M3 18h13"></path>
                        </svg>
                        A-Z
                    </button>
                    <button id="sort-popular" class="sort-btn" title="Sort by popularity">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Popular
                    </button>
                </div>
            </div>

            <div id="systems-grid" class="systems-grid">
                <!-- Systems will be injected here -->
            </div>
        </main>

        <footer>
            <p>Developed by Arthur Juliani | <a href="https://github.com/awjuliani/metaphysics-quiz"
                    target="_blank">View Source</a></p>
        </footer>
    </div>

    <script src="js/theme.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Theme is handled by js/theme.js (auto-initializes on load)
        setupThemeToggle();

        // Store systems and stats globally for re-sorting
        let allSystems = [];
        let systemStats = {};
        let totalCount = 0;
        let currentSort = 'alpha'; // Default to alphabetical

        // Render systems to the grid
        function renderSystems(systems) {
            const grid = document.getElementById('systems-grid');
            grid.innerHTML = '';

            systems.forEach(system => {
                const card = document.createElement('div');
                card.className = 'card system-card';
                const systemId = getSystemSlug(system.name);
                card.id = systemId;

                const popularityHtml = getPopularityHtml(system.name, systemStats, totalCount);

                const profileKeys = Object.keys(system.profile);
                const metaHtml = profileKeys.map(key => `
                    <div class="meta-item">
                        <span class="label">${key}</span>
                        <a href="dimensions.html#${key}" class="value dimension-link">${system.profile[key]}</a>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="card-header-flex" style="display: flex; justify-content: space-between; align-items: start;">
                        <h2>${system.name}</h2>
                        ${popularityHtml}
                    </div>
                    <p class="system-description">${system.description}</p>
                    <div class="system-links">
                        <a href="${system.wiki}" target="_blank" class="wiki-link">Read on Wikipedia &rarr;</a>
                        ${system.primary_source ? `<div class="primary-source"><span class="source-label">ðŸ“– Recommended:</span> <em class="source-text">${system.primary_source}</em></div>` : ''}
                    </div>
                    <div class="system-meta">
                        ${metaHtml}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Sort and render systems
        function sortSystems(sortType) {
            currentSort = sortType;
            const sorted = [...allSystems];

            if (sortType === 'alpha') {
                sorted.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortType === 'popular') {
                sorted.sort((a, b) => {
                    const countA = systemStats[a.name] || 0;
                    const countB = systemStats[b.name] || 0;
                    return countB - countA; // Descending by popularity
                });
            }

            renderSystems(sorted);

            // Update button states
            document.getElementById('sort-alpha').classList.toggle('active', sortType === 'alpha');
            document.getElementById('sort-popular').classList.toggle('active', sortType === 'popular');
        }

        // Load Systems
        async function loadSystems() {
            try {
                const [systemsResponse, stats] = await Promise.all([
                    fetch('data/systems.json'),
                    getSystemStats()
                ]);

                allSystems = await systemsResponse.json();
                systemStats = stats;
                totalCount = Object.values(stats).reduce((a, b) => a + b, 0);

                // Initial sort (alphabetical)
                sortSystems('alpha');

                // Set up sort button listeners
                document.getElementById('sort-alpha').addEventListener('click', () => sortSystems('alpha'));
                document.getElementById('sort-popular').addEventListener('click', () => sortSystems('popular'));

                // Check for hash and scroll to it
                if (window.location.hash) {
                    const id = window.location.hash.substring(1);
                    const element = document.getElementById(id);
                    if (element) {
                        setTimeout(() => {
                            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            element.style.borderColor = 'var(--primary-color)';
                            element.style.boxShadow = '0 0 0 2px var(--primary-color)';
                            setTimeout(() => {
                                element.style.borderColor = '';
                                element.style.boxShadow = '';
                            }, 2000);
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error loading systems:', error);
                document.getElementById('systems-grid').innerHTML = '<p>Error loading systems. Please try again later.</p>';
            }
        }

        loadSystems();
    </script>
</body>

</html>