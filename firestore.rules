rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Match the system_stats collection
    match /system_stats/{docId} {
      
      // Anyone can read the stats
      allow read: if true;
      
      // Allow creating a new document ONLY if:
      // 1. It contains 'name' and 'count' fields
      // 2. 'count' is initialized to 1
      allow create: if request.resource.data.keys().hasAll(['name', 'count'])
                    && request.resource.data.count == 1
                    && request.resource.data.name is string;
      
      // Allow updating a document ONLY if:
      // 1. Only the 'count' field is being changed
      // 2. The new count is exactly existing count + 1
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['count'])
                    && request.resource.data.count == resource.data.count + 1;
                    
      // Disallow deleting documents
      allow delete: if false;
    }
  }
}
